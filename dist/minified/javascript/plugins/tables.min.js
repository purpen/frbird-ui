!function(t){t.Editable.commands=t.extend(t.Editable.commands,{table:{title:"Table",icon:"fa fa-table",callback:function(t,e,a){this.table_commands[e]?this.table_commands[e].apply(this,[e,a]):this.table_commands.insertTable.apply(this,[e,a]),this.cleanupTables()}}}),t.Editable.DEFAULTS.buttons[t.Editable.DEFAULTS.buttons.indexOf("insertHorizontalRule")]="table",t.Editable.prototype.table_commands={insertTable:function(t,e){this.insertTable(t,e)},insertRowAbove:function(){this.insertRow("above")},insertRowBelow:function(){this.insertRow("below")},insertColumnBefore:function(){this.insertColumn("before")},insertColumnAfter:function(){this.insertColumn("after")},deleteColumn:function(){this.deleteColumn()},deleteRow:function(){this.deleteRow()},insertCellBefore:function(){this.insertCell("before")},insertCellAfter:function(){this.insertCell("after")},mergeCells:function(){this.mergeCells()},deleteCell:function(){this.deleteCell()},splitVertical:function(){this.splitVertical()},splitHorizontal:function(){this.splitHorizontal()},insertHeader:function(){this.insertHeader()},deleteHeader:function(){this.deleteHeader()},deleteTable:function(){this.deleteTable()}},t.Editable.prototype.command_dispatcher=t.extend(t.Editable.prototype.command_dispatcher,{table:function(t){var e=this.buildDropdownTable(),a=this.buildDropdownButton(t,e,"fr-table");return this.bindTableDropdownEvents(),a}}),t.Editable.prototype.tableTab=function(){var e;this.currentCell&&(e=this.currentCell());var a=t(this.getSelectionElement());return a.parents("ul, ol").length>0||(e&&this.nextCell()?(this.setSelection(this.nextCell()),!1):void 0)},t.Editable.prototype.tableShiftTab=function(){var e;this.currentCell&&(e=this.currentCell());var a=t(this.getSelectionElement());return a.parents("ul, ol").length>0||(e&&this.prevCell()?(this.setSelection(this.prevCell()),!1):void 0)},t.Editable.prototype.initTable=function(){var e=this;this.$editor.on("click mouseup touch touchend",".fr-table a",function(a){a.preventDefault(),a.stopPropagation(),e.android()&&(t(this).parent().siblings().removeClass("hover"),t(this).parent().addClass("hover"))}),this.addListener("tab",this.tableTab),this.addListener("shift+tab",this.tableShiftTab)},t.Editable.initializers.push(t.Editable.prototype.initTable),t.Editable.prototype.buildDropdownTable=function(){var t='<ul class="fr-dropdown-menu fr-table">';t+='<li> <a href="#"><span data-text="true">Insert table</span> <i class="fa fa-chevron-right"></i></a><div class="select-table"> ',t+='<div class="fr-t-info">1 x 1</div>';for(var e=1;e<=10;e++){for(var a=1;a<=10;a++){var r="inline-block";(e>5||a>5)&&(r="none");var l="fr-bttn ";1==e&&1==a&&(l+=" hover"),t+='<span class="'+l+'" data-cmd="table" data-val="'+e+'" data-param="'+a+'" style="display: '+r+';"><span></span></span>'}t+='<div class="new-line"></div>'}return t+="</div> </li>",t+='<li><a href="#"><span data-text="true">Cell</span> <i class="fa fa-chevron-right"></i></a> <ul> <li data-cmd="table" data-val="insertCellBefore"><a href="#" data-text="true">Insert cell before</a></li><li data-cmd="table" data-val="insertCellAfter"><a href="#" data-text="true">Insert cell after</a></li><li data-cmd="table" data-val="deleteCell"><a href="#" data-text="true">Delete cell</a></li><li data-cmd="table" data-val="mergeCells"><a href="#" data-text="true">Merge cells</a></li><li data-cmd="table" data-val="splitHorizontal"><a href="#" data-text="true">Horizontal split</a></li><li data-cmd="table" data-val="splitVertical"><a href="#" data-text="true">Vertical split</a></li></ul></li>',t+='<li><a href="#"><span data-text="true">Row</span> <i class="fa fa-chevron-right"></i></a> <ul><li data-cmd="table" data-val="insertRowAbove"><a href="#" data-text="true">Insert row above</a></li><li data-cmd="table" data-val="insertRowBelow"><a href="#" data-text="true">Insert row below</a></li><li data-cmd="table" data-val="deleteRow"><a href="#" data-text="true">Delete row</a></li></ul></li>',t+='<li><a href="#"><span data-text="true">Column</span> <i class="fa fa-chevron-right"></i></a> <ul> <li data-cmd="table" data-val="insertColumnBefore"><a href="#" data-text="true">Insert column before</a></li> <li data-cmd="table" data-val="insertColumnAfter"><a href="#" data-text="true">Insert column after</a></li> <li data-cmd="table" data-val="deleteColumn"><a href="#" data-text="true">Delete column</a></li> </ul></li>',t+='<li data-cmd="table" data-val="deleteTable"><a href="#" data-text="true">Delete table</a></li>',t+="</ul>"},t.Editable.prototype.bindTableDropdownEvents=function(){var e=this;this.$bttn_wrapper.on("mouseenter",".fr-table .select-table > span",function(){var a=t(this).data("val"),r=t(this).data("param");e.$bttn_wrapper.find(".fr-table .select-table .fr-t-info").text(a+" x "+r),e.$bttn_wrapper.find(".fr-table .select-table > span").removeClass("hover");for(var l=1;l<=10;l++)for(var i=0;i<=10;i++){var n=e.$bttn_wrapper.find('.fr-table .select-table > span[data-val="'+l+'"][data-param="'+i+'"]');l<=a&&i<=r?n.addClass("hover"):(l<=a+1||l<=5)&&(i<=r+1||i<=5)?n.css("display","inline-block"):(l>5||i>5)&&n.css("display","none")}}),this.$bttn_wrapper.on("mouseleave",".fr-table .select-table",function(){e.$bttn_wrapper.find('.fr-table .select-table > span[data-val="1"][data-param="1"]').trigger("mouseenter")}),this.android()&&this.$bttn_wrapper.on("touchend",".fr-table .fr-trigger",function(){t(this).parents(".fr-table").find(".hover").removeClass("hover")})},t.Editable.prototype.tableMap=function(){var e=this.currentTable(),a=[];return e&&e.find("tr:not(:empty)").each(function(e,r){var l=t(r),i=0;l.find("th, td").each(function(r,l){for(var n=t(l),o=parseInt(n.attr("colspan"),10)||1,s=parseInt(n.attr("rowspan"),10)||1,d=e;d<e+s;d++)for(var h=i;h<i+o;h++)a[d]||(a[d]=[]),a[d][h]?i++:a[d][h]=l;i+=o})}),a},t.Editable.prototype.cellOrigin=function(t,e){for(var a=0;a<e.length;a++)for(var r=0;r<e[a].length;r++)if(e[a][r]==t)return{row:a,col:r}},t.Editable.prototype.canMergeCells=function(){var e=this.getSelectionCells();if(e.length<2)return!1;for(var a=this.tableMap(),r=0,l=32e3,i=0,n=32e3,o=0,s=0;s<e.length;s++){var d=t(e[s]),h=parseInt(d.attr("colspan"),10)||1,f=parseInt(d.attr("rowspan"),10)||1,c=this.cellOrigin(e[s],a);r+=h*f,l=Math.min(l,c.col),i=Math.max(i,c.col+h),n=Math.min(n,c.row),o=Math.max(o,c.row+f)}return r==(i-l)*(o-n)?{row:n,col:l,colspan:i-l,rowspan:o-n,map:a,cells:e}:null},t.Editable.prototype.getSelectionCells=function(){var e,a=[];if(this.browser.webkit||this.browser.msie){var r=this.getSelectionElements();for(e=0;e<r.length;e++)"TD"!=r[e].tagName&&"TH"!=r[e].tagName||a.push(r[e])}else{var l=this.getRanges();for(e=0;e<l.length;e++){var i=l[e],n=!1;if("TD"==i.startContainer.tagName||"TH"==i.startContainer.tagName)a.push(i.startContainer),n=!0;else{var o=i.startContainer.childNodes,s=i.startOffset;if(o.length>s&&s>=0){var d=o[s];"TD"!=d.tagName&&"TH"!=d.tagName||(a.push(d),n=!0)}}if(n===!1){var h=t(i.startContainer).parents("td:first, th:first");h.length>0&&a.push(h.get(0))}}}return a},t.Editable.prototype.currentCell=function(){var t=this.getSelectionCells();return t.length>0?t[0]:null},t.Editable.prototype.prevCell=function(){var e=this.currentCell();if(e){if(t(e).prev("td").length)return t(e).prev("td").get(0);if(t(e).parent().prev("tr").find("td").length)return t(e).parent().prev("tr").find("td:last").get(0)}return null},t.Editable.prototype.nextCell=function(){var e=this.currentCell();if(e){if(t(e).next("td").length)return t(e).next("td").get(0);if(t(e).parent().next("tr").find("td").length)return t(e).parent().next("tr").find("td").get(0)}return null},t.Editable.prototype.currentTable=function(){for(var e=t(this.getSelectionElement());e.get(0)!=this.$element.get(0)&&e.get(0)!=this.$document.find("body").get(0)&&"TABLE"!=e.get(0).tagName;)e=e.parent();return e.get(0)!=this.$element.get(0)?e:null},t.Editable.prototype.focusOnTable=function(){var t=this.currentTable();if(t){var e=t.find("td:first");this.setSelection(e.get(0))}},t.Editable.prototype.insertCell=function(e){for(var a=this.getSelectionCells(),r=0;r<a.length;r++){var l=t(a[r]);"before"==e?l.before(l.clone().removeAttr("colspan").removeAttr("rowspan").html(t.Editable.INVISIBLE_SPACE)):"after"==e&&l.after(l.clone().removeAttr("colspan").removeAttr("rowspan").html(t.Editable.INVISIBLE_SPACE))}"before"==e?this.triggerEvent("cellInsertedBefore"):"after"==e&&this.triggerEvent("cellInsertedAfter")},t.Editable.prototype.mergeCells=function(){var e=this.canMergeCells();if(e){var a=t(e.map[e.row][e.col]);a.attr("colspan",e.colspan),a.attr("rowspan",e.rowspan);for(var r=0;r<e.cells.length;r++){var l=e.cells[r];if(a.get(0)!=l){var i=t(l);a.append(i.html()),i.remove()}}this.setSelection(a.get(0))}this.hide(),this.triggerEvent("cellsMerged")},t.Editable.prototype.deleteCell=function(){for(var e=this.getSelectionCells(),a=0;a<e.length;a++){var r=t(e[a]);r.remove()}this.focusOnTable(),this.hide(),this.triggerEvent("cellDeleted")},t.Editable.prototype.insertHeader=function(){var t=this.currentTable();t&&t.find(" > thead").length>0&&this.triggerEvent("headerInserted")},t.Editable.prototype.deleteHeader=function(){},t.Editable.prototype.insertColumn=function(e){var a=this.currentCell();if(a)for(var r=t(a),l=this.tableMap(),i=this.cellOrigin(r.get(0),l),n=0;n<l.length;n++){var o=l[n][i.col],s=parseInt(t(o).attr("colspan"),10)||1,d=parseInt(t(o).attr("rowspan"),10)||1;if("before"==e){var h=l[n][i.col-1];h?h==o?t(h).attr("colspan",s+1):d>1?t(h).after("<"+h.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+h.tagName+">"):t(o).before("<"+o.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+o.tagName+">"):t(o).before("<"+o.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+o.tagName+">")}else if("after"==e){var f=l[n][i.col+1];f?f==o?t(f).attr("colspan",s+1):d>1?t(f).before("<"+f.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+f.tagName+">"):t(o).after("<"+o.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+o.tagName+">"):t(o).after("<"+o.tagName+">"+t.Editable.INVISIBLE_SPACE+"</"+o.tagName+">")}}this.hide(),"before"==e?this.triggerEvent("columnInsertedBefore"):"after"==e&&this.triggerEvent("columnInsertedAfter")},t.Editable.prototype.deleteColumn=function(){for(var e=this.getSelectionCells(),a=0;a<e.length;a++)for(var r=t(e[a]),l=this.tableMap(),i=this.cellOrigin(r.get(0),l),n=0;n<l.length;n++){var o=l[n][i.col],s=parseInt(t(o).attr("colspan"),10)||1;1==s?t(o).remove():t(o).attr("colspan",s-1)}this.focusOnTable(),this.hide(),this.triggerEvent("columnDeleted")},t.Editable.prototype.insertRow=function(e){var a,r=this.currentCell();if(r){var l=t(r),i=this.tableMap(),n=this.cellOrigin(l.get(0),i),o=0,s=null;for(a=0;a<i[n.row].length;a++){var d=i[n.row][a],h=parseInt(t(d).attr("rowspan"),10)||1;if("above"==e)if(0===n.row)o++;else{var f=i[n.row-1][a];f==d&&s!=d?t(d).attr("rowspan",h+1):o++}else if("below"==e)if(n.row==i.length-1)o++;else{var c=i[n.row+1][a];c==d&&s!=d?t(d).attr("rowspan",h+1):o++}s=i[n.row][a]}var p="<tr>";for(a=0;a<o;a++)p+="<td>"+t.Editable.INVISIBLE_SPACE+"</td>";p+="</tr>","below"==e?l.closest("tr").after(p):"above"==e&&l.closest("tr").before(p)}this.hide(),"below"==e?this.triggerEvent("rowInsertedBelow"):"above"==e&&this.triggerEvent("rowInsertedAbove")},t.Editable.prototype.deleteRow=function(){for(var e=this.getSelectionCells(),a=0;a<e.length;a++){var r=t(e[a]),l=this.tableMap(),i=this.cellOrigin(r.get(0),l),n=r.parents("tr:first");if(i)for(var o=0;o<l[i.row].length;o++){var s=l[i.row][o],d=parseInt(t(s).attr("rowspan"),10)||1;if(1==d)t(s).remove();else{var h=this.cellOrigin(s,l);if(t(s).attr("rowspan",d-1),h.row==i.row){var f=l[i.row+1];f&&f[o-1]&&(t(f[o-1]).after(t(s).clone()),t(s).remove())}}}n.remove()}this.focusOnTable(),this.hide(),this.triggerEvent("rowDeleted")},t.Editable.prototype.splitVertical=function(){for(var e=this.getSelectionCells(),a=0;a<e.length;a++){var r=t(e[a]),l=this.tableMap(),i=this.cellOrigin(r.get(0),l),n=parseInt(r.attr("colspan"),10)||1,o=parseInt(r.attr("rowspan"),10)||1;if(o>1){var s=Math.floor(o/2),d=i.row+(o-s),h=l[d][i.col-1];h||(h=l[d][i.col+n]),h?t(h).before(r.clone().attr("rowspan",s).html(t.Editable.INVISIBLE_SPACE)):r.parents("tr:first").after(t("<tr>").append(r.clone().attr("rowspan",s).html(t.Editable.INVISIBLE_SPACE))),r.attr("rowspan",o-s)}else{for(var f=t("<tr>").append(r.clone().html(t.Editable.INVISIBLE_SPACE)),c=null,p=0;p<l[i.row].length;p++){var b=l[i.row][p],u=parseInt(t(b).attr("rowspan"),10)||1;c!=b&&b!=r.get(0)&&t(b).attr("rowspan",u+1),c=b}r.parents("tr:first").after(f)}}this.hide(),this.triggerEvent("cellVerticalSplit")},t.Editable.prototype.splitHorizontal=function(){for(var e=this.getSelectionCells(),a=0;a<e.length;a++){var r=t(e[a]),l=this.tableMap(),i=this.cellOrigin(r.get(0),l),n=parseInt(r.attr("colspan"),10)||1;if(n>1){var o=Math.floor(n/2);r.after(r.clone().attr("colspan",o).html(t.Editable.INVISIBLE_SPACE)),r.attr("colspan",n-o)}else{for(var s=null,d=0;d<l.length;d++){var h=l[d][i.col],f=parseInt(t(h).attr("colspan"),10)||1;s!=h&&h!=r.get(0)&&t(h).attr("colspan",f+1),s=h}r.after(r.clone().html(t.Editable.INVISIBLE_SPACE))}}this.hide(),this.triggerEvent("cellHorizontalSplit")},t.Editable.prototype.insertTable=function(e,a){for(var r='<table data-last-table="true" width="100%">',l=0;l<e;l++){r+="<tr>";for(var i=0;i<a;i++)r+="<td>"+t.Editable.INVISIBLE_SPACE+"</td>";r+="</tr>"}r+="</table>",this.focus();var n=this.getSelectionElement();this.breakHTML(r,this.parents(t(n),"li").length<0);var o=this.$element.find('table[data-last-table="true"]');o.removeAttr("data-last-table"),this.setSelection(o.find("td:first").get(0)),this.hide(),this.triggerEvent("tableInserted")},t.Editable.prototype.deleteTable=function(){var t=this.currentTable();t&&(t.remove(),this.focus(),this.hide(),this.triggerEvent("tableDeleted"))},t.Editable.prototype.cleanupTables=function(){this.$element.find('td[colspan="1"], th[colspan="1"]').each(function(){t(this).removeAttr("colspan")}),this.$element.find('td[rowspan="1"], th[rowspan="1"]').each(function(){t(this).removeAttr("rowspan")})}}(jQuery);