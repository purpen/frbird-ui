!function(e){e.Editable.DEFAULTS=e.extend(e.Editable.DEFAULTS,{allowedImageTypes:["jpeg","jpg","png","gif"],customImageButtons:{},defaultImageTitle:"Image title",defaultImageWidth:300,defaultImageDisplay:"block",defaultImageAlignment:"center",imageDeleteConfirmation:!0,imageDeleteURL:null,imageDeleteParams:{},imageMove:!0,imageResize:!0,imageLink:!0,imageTitle:!0,imageUpload:!0,imageUploadParams:{},imageUploadParam:"file",imageUploadURL:"http://i.froala.com/upload",maxImageSize:5242880,pasteImage:!0,textNearImage:!0,assetType:2,assetDomain:"asset",parent_id:0,is_string:0,fetchUploadURL:""}),e.Editable.commands=e.extend(e.Editable.commands,{multiUpload:{title:"Multi Upload",icon:"fa fa-picture-o",callback:function(){this.insertAsset()},undo:!1}}),e.Editable.prototype.showAssetWrapper=function(){this.$asset_wrapper&&this.$asset_wrapper.show()},e.Editable.prototype.hideAssetWrapper=function(){this.$asset_wrapper&&this.$asset_wrapper.hide()},e.Editable.prototype.showAssetUpload=function(){this.hidePopups(),this.showAssetWrapper()},e.Editable.prototype.insertAsset=function(){this.closeImageMode(),this.imageMode=!1,this.showAssetUpload(),this.saveSelectionByMarkers(),this.options.inlineMode||this.positionPopup("multiUpload")},e.Editable.prototype.assetUploadHTML=function(){var e='<div class="froala-popup froala-asset-popup" style="display: none;"><h4><span data-text="true">Multi Upload</span><small> (小于5M,jpg、jpeg的格式）</small><i title="Cancel" class="fa fa-times" id="f-asset-close-'+this._id+'"></i></h4>';return e+='<div id="f-asset-list-'+this._id+'" class="editor-assets">',e+='<div id="multi-upload-'+this._id+'"></div>',e+='<div id="multi-list-'+this._id+'" class="ui three blocks"></div>',e+="</div>",e+='<div class="select-result"><div class="ui ok active inverted magenta button">确定插入</div><div class="ui notok inverted grey button">取消</div><div class="ui remove inverted red button">删除所选</div></div>',e+="</div>"},e.Editable.prototype.multiUploadAsset=function(){this.$asset_wrapper=e(this.assetUploadHTML()),this.$popup_editor.append(this.$asset_wrapper),this.$select_assets=new Array,this.$select_ids=new Array;var s=this;this.addListener("hidePopups",e.proxy(function(){this.hideAssetWrapper()},this)),this.loadAssets();var t=new qq.FineUploader({element:e("#multi-upload-"+s._id)[0],request:{inputName:s.options.imageUploadParam,params:s.options.imageUploadParams,endpoint:s.options.imageUploadURL},text:{uploadButton:'<a class="ui active grey labeled icon button" href="javascript:void(0);"><i class="cloud upload icon"></i>选择图片</a>'},validation:{allowedExtensions:["jpeg","jpg","png","gif"],sizeLimit:5245728},callbacks:{onUpload:function(e,i){s.options.imageUploadParams["x:ord"]+=e,t.setParams(s.options.imageUploadParams)},onComplete:function(t,i,a,o){console.log("id: "+t+" name: "+i+"result: "+a),a.is_error?phenix.show_error_message(a.message):(e(".qq-upload-list").children().eq(t).fadeOut(),e.getJSON(s.options.fetchUploadURL,{assets:a.data.ids,is_string:s.options.is_string,asset_type:s.options.assetType,asset_domain:s.options.assetDomain},function(e){return e.is_error?void phenix.show_error_message(e.message):(s.renderAssets(e),void s.buildAssetIds(e))}))}}});e("#multi-list-"+this._id).find("img").livequery(function(t){e(this).bind("click",function(){var t=e(this).parent(".image").data("src"),i=e(this).parent(".image").data("id");t&&(s.$select_assets.push(t),s.$select_ids.push(i),e(this).after('<div class="cover"><i class="check circle icon"></i></div>'))})}).end().find(".cover").livequery(function(t){e(this).bind("click",function(){console.log("click cover");var t=e(this).parent(".image").data("src"),i=-1;e(this).remove();for(var a=0,o=s.$select_assets.length;a<o;a++)s.$select_assets[a]==t&&(i=a);i!=-1&&(s.$select_assets.splice(i,1),s.$select_ids.splice(i,1))})}),this.$asset_wrapper.on("click","div.ui.ok.button",e.proxy(function(){if(this.$select_assets.length){for(var e="",t=0,i=s.$select_assets.length;t<i;t++)e+='<p><img class="fr-fin fr-dib" src="'+s.$select_assets[t]+'" alt="'+s.options.defaultImageTitle+'"></p>';this.insertHTML(e),this.cancelSelected(),this.$bttn_wrapper.show(),this.hideAssetWrapper(),this.options.inlineMode&&!this.imageMode&&0===this.options.buttons.length&&this.hide(),this.restoreSelection(),this.focus(),this.options.inlineMode||this.hide()}else phenix.show_error_note("请至少选择一个要插入的图片！")},this)),this.$asset_wrapper.on("click","div.ui.remove.button",e.proxy(function(){if(s.$select_assets.length)for(var t=0,i=s.$select_assets.length;t<i;t++){var a=s.$select_ids[t];e("#asset-"+a).remove(),e.getJSON(this.options.imageDeleteURL,{asset_id:a},function(e){if(e.is_error)return void phenix.show_error_note(e.message)})}else phenix.show_error_note("请至少选择一个要删除的图片！")},this)),this.$asset_wrapper.on("click","div.ui.notok.button",e.proxy(function(){this.cancelSelected(),this.$bttn_wrapper.show(),this.hideAssetWrapper(),this.options.inlineMode&&!this.imageMode&&0===this.options.buttons.length&&this.hide(),this.restoreSelection(),this.focus(),this.options.inlineMode||this.hide()},this)),this.$asset_wrapper.on(this.mouseup,"i#f-asset-close-"+this._id,e.proxy(function(){this.$bttn_wrapper.show(),this.hideAssetWrapper(),this.options.inlineMode&&!this.imageMode&&0===this.options.buttons.length&&this.hide(),this.restoreSelection(),this.focus(),this.options.inlineMode||this.hide()},this))},e.Editable.prototype.cancelSelected=function(){this.$select_assets=[],e("#multi-list-"+this._id).find(".cover").remove()},e.Editable.prototype.loadAssets=function(){var s=this;this.options.parent_id&&e.getJSON(this.options.fetchUploadURL,{parent_id:this.options.parent_id,is_string:this.options.is_string,asset_type:this.options.assetType,asset_domain:this.options.assetDomain},function(e){return e.is_error?void phenix.show_error_message(e.message):(console.log(e),void s.renderAssets(e))})},e.Editable.prototype.renderAssets=function(s){var t='{{#data}}<div class="block" id="asset-{{ id }}"><div class="image" data-id="{{ id }}" data-src="{{ img_url }}"><img src="{{ thumbnails.mini.view_url }}" /><p>{{ filename }}</p></div></div>{{/data}}',i=Mustache.render(t,s);e("#multi-list-"+this._id).prepend(i)},e.Editable.prototype.buildAssetIds=function(s){var t="{{#data}}{{ id }},{{/data}}",i=Mustache.render(t,s);console.log("value: "+i);var a=e("#newadd_asset_ids").val();a+=i,e("#newadd_asset_ids").val(a)},e.Editable.initializers.push(e.Editable.prototype.multiUploadAsset)}(jQuery);