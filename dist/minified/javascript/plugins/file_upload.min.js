!function(i){i.Editable.commands=i.extend(i.Editable.commands,{uploadFile:{title:"Upload File",icon:"fa fa-paperclip",callback:function(){this.insertFile()},undo:!1}}),i.Editable.DEFAULTS=i.extend(i.Editable.DEFAULTS,{allowedFileTypes:["*"],fileDeleteUrl:null,fileDeleteParams:{},fileUploadParams:{},fileUploadURL:"http://i.froala.com/upload",fileUploadParam:"file",maxFileSize:10485760,useFileName:!0}),i.Editable.prototype.showFileWrapper=function(){this.$file_wrapper&&this.$file_wrapper.show()},i.Editable.prototype.hideFileWrapper=function(){this.$file_wrapper&&(this.$file_wrapper.hide(),this.$file_wrapper.find("input").blur())},i.Editable.prototype.showFileUpload=function(){this.hidePopups(),this.showFileWrapper()},i.Editable.prototype.insertFile=function(){this.closeImageMode(),this.imageMode=!1,this.showFileUpload(),this.saveSelectionByMarkers(),this.options.inlineMode||this.positionPopup("uploadFile")},i.Editable.prototype.fileUploadHTML=function(){var e='<div class="froala-popup froala-file-popup" style="display: none;"><h4><span data-text="true">Upload file</span><i title="Cancel" class="fa fa-times" id="f-file-close-'+this._id+'"></i></h4>';return e+='<div id="f-file-list-'+this._id+'">',e+='<div class="f-popup-line drop-upload">',e+='<div class="f-upload" id="f-file-upload-div-'+this._id+'"><strong data-text="true">Drop File</strong><br>(<span data-text="true">or click</span>)<form target="file-frame-'+this._id+'" enctype="multipart/form-data" encoding="multipart/form-data" action="'+this.options.fileUploadURL+'" method="post" id="f-file-form-'+this._id+'"><input id="f-file-upload-'+this._id+'" type="file" name="'+this.options.fileUploadParam+'" accept="/*"></form></div>',this.browser.msie&&i.Editable.getIEversion()<=9&&(e+='<iframe id="file-frame-'+this._id+'" name="file-frame-'+this._id+'" src="javascript:false;" style="width:0; height:0; border:0px solid #FFF; position: fixed; z-index: -1;" data-loaded="true"></iframe>'),e+="</div>",e+="</div>",e+='<p class="f-progress" id="f-file-progress-'+this._id+'"><span></span></p>',e+="</div>"},i.Editable.prototype.buildFileDrag=function(){var e=this;e.$file_wrapper.on("dragover","#f-file-upload-div-"+this._id,function(){return i(this).addClass("f-hover"),!1}),e.$file_wrapper.on("dragend","#f-file-upload-div-"+this._id,function(){return i(this).removeClass("f-hover"),!1}),e.$file_wrapper.on("drop","#f-file-upload-div-"+this._id,function(t){t.preventDefault(),t.stopPropagation(),i(this).removeClass("f-hover"),e.uploadFile(t.originalEvent.dataTransfer.files)}),e.$element.on("drop",function(t){var o=t.originalEvent.dataTransfer.files;if(0===i(".froala-element img.fr-image-move").length&&t.originalEvent.dataTransfer&&o&&o.length){if(e.isDisabled)return!1;e.options.allowedImageTypes.indexOf(o[0].type.replace(/image\//g,""))<0&&(e.closeImageMode(),e.hide(),e.imageMode=!1,e.initialized||(e.$element.unbind("mousedown.element"),e.lateInit()),e.insertMarkersAtPoint(t.originalEvent),e.showByCoordinates(t.originalEvent.pageX,t.originalEvent.pageY),e.uploadFile(o),t.preventDefault(),t.stopPropagation())}})},i.Editable.prototype.buildFileUpload=function(){this.$file_wrapper=i(this.fileUploadHTML()),this.$popup_editor.append(this.$file_wrapper),this.buildFileDrag();var e=this;if(this.$file_wrapper.on("mouseup touchend",i.proxy(function(i){this.isResizing()||i.stopPropagation()},this)),this.addListener("hidePopups",i.proxy(function(){this.hideFileWrapper()},this)),this.$file_progress_bar=this.$file_wrapper.find("p#f-file-progress-"+this._id),this.browser.msie&&i.Editable.getIEversion()<=9){var t=this.$file_wrapper.find("iframe").get(0);t.attachEvent?t.attachEvent("onload",function(){e.iFrameLoad()}):t.onload=function(){e.iFrameLoad()}}this.$file_wrapper.on("change",'input[type="file"]',function(){if(void 0!==this.files)e.uploadFile(this.files);else{var t=i(this).parents("form");t.find('input[type="hidden"]').remove();var o;for(o in e.options.fileUploadParams)t.prepend('<input type="hidden" name="'+o+'" value="'+e.options.fileUploadParams[o]+'" />');e.$file_wrapper.find("#f-file-list-"+e._id).hide(),e.$file_progress_bar.show(),e.$file_progress_bar.find("span").css("width","100%").text("Please wait!"),e.showFileUpload(),t.submit()}i(this).val("")}),this.$file_wrapper.on(this.mouseup,"#f-file-close-"+this._id,i.proxy(function(i){i.stopPropagation(),i.preventDefault(),this.$bttn_wrapper.show(),this.hideFileWrapper(),this.restoreSelection(),this.focus(),this.hide()},this)),this.$file_wrapper.on("click",function(i){i.stopPropagation()}),this.$file_wrapper.on("click","*",function(i){i.stopPropagation()})},i.Editable.initializers.push(i.Editable.prototype.buildFileUpload),i.Editable.prototype.uploadFile=function(e){if(!this.triggerEvent("beforeFileUpload",[e],!1))return!1;if(void 0!==e&&e.length>0){var t;if(this.drag_support.formdata&&(t=this.drag_support.formdata?new FormData:null),t){var o;for(o in this.options.fileUploadParams)t.append(o,this.options.fileUploadParams[o]);if(t.append(this.options.fileUploadParam,e[0]),e[0].size>this.options.maxFileSize)return this.throwFileError(5),!1;if(this.options.allowedFileTypes.indexOf(e[0].type)<0&&this.options.allowedFileTypes.indexOf("*")<0)return this.throwFileError(6),!1}if(t){var r;if(this.options.crossDomain)r=this.createCORSRequest("POST",this.options.fileUploadURL);else{r=new XMLHttpRequest,r.open("POST",this.options.fileUploadURL);for(var s in this.options.headers)r.setRequestHeader(s,this.options.headers[s])}var a=e[0].name;r.onload=i.proxy(function(){this.$file_progress_bar.find("span").css("width","100%").text("Please wait!");try{r.status>=200&&r.status<300?this.parseFileResponse(r.responseText,a):this.throwFileError(3)}catch(i){this.throwFileError(4)}},this),r.onerror=i.proxy(function(){this.throwFileError(3)},this),r.upload.onprogress=i.proxy(function(i){if(i.lengthComputable){var e=i.loaded/i.total*100|0;this.$file_progress_bar.find("span").css("width",e+"%")}},this),r.send(t),this.$file_wrapper.find("#f-file-list-"+this._id).hide(),this.$file_progress_bar.show(),this.showFileUpload()}}},i.Editable.prototype.throwFileError=function(i){var e="Unknown file upload error.";1==i?e="Bad link.":2==i?e="No link in upload response.":3==i?e="Error during file upload.":4==i?e="Parsing response failed.":5==i?e="File too large.":6==i?e="Invalid file type.":7==i&&(e="File can be uploaded only to same domain in IE 8 and IE 9."),this.triggerEvent("fileError",[{code:i,message:e}],!1),this.hideFileLoader()},i.Editable.prototype.hideFileLoader=function(){this.$file_progress_bar.hide(),this.$file_progress_bar.find("span").css("width","0%").text(""),this.$file_wrapper.find("#f-file-list-"+this._id).show()},i.Editable.prototype.throwFileErrorWithMessage=function(i){this.triggerEvent("fileError",[{message:i,code:0}],!1),this.hideFileLoader()},i.Editable.prototype.parseFileResponse=function(e,t){try{if(!this.triggerEvent("afterFileUpload",[e],!1))return!1;var o=i.parseJSON(e);o.link?this.writeFile(o.link,t,e):o.error?this.throwFileErrorWithMessage(o.error):this.throwFileError(2)}catch(r){this.throwFileError(4)}},i.Editable.prototype.writeFile=function(i,e,t){this.restoreSelectionByMarkers(),this.focus(),this.options.useFileName||""===this.text()||(e=this.text()),this.insertHTML('<a class="fr-file" href="'+this.sanitizeURL(i)+'">'+e+"</a>"),this.hide(),this.hideFileLoader(),this.focus(),this.triggerEvent("fileUploaded",[e,i,t])}}(jQuery);